# GitHub Actions å·¥ä½œæµåˆ†æ - å¤šåŒ…å‘å¸ƒæµç¨‹

## æ¦‚è¿°

è¯¥ GitHub Actions å·¥ä½œæµæ–‡ä»¶(`release.yml`)æ˜¯ä¸€ä¸ªä¸“ä¸º monorepo å¤šåŒ…é¡¹ç›®è®¾è®¡çš„è‡ªåŠ¨åŒ–å‘å¸ƒç³»ç»Ÿï¼Œæ”¯æŒå¿«ç…§ç‰ˆæœ¬å‘å¸ƒã€å‘å¸ƒæ£€æŸ¥å’Œç”Ÿäº§ç¯å¢ƒå‘å¸ƒä¸‰ç§æ ¸å¿ƒåŠŸèƒ½ã€‚

## å¿«é€Ÿå‚è€ƒè¡¨

| ä»»åŠ¡åç§° | è§¦å‘æ–¹å¼ | æ‰§è¡Œåˆ†æ”¯ | å‘å¸ƒç›®æ ‡ | ä¸»è¦ç”¨é€” |
| --- | --- | --- | --- | --- |
| **snapshot-publish** | è‡ªåŠ¨ï¼šPush åˆ°`test`/`feat/*`<br/>æ‰‹åŠ¨ï¼šé€‰æ‹©å¿«ç…§å‘å¸ƒ | `test`, `feat/*` | NPM (beta æ ‡ç­¾) | å¼€å‘æµ‹è¯•ç¯å¢ƒé¢„å‘å¸ƒ |
| **check-releases-packages** | è‡ªåŠ¨ï¼šPush åˆ°`main`<br/>æ‰‹åŠ¨ï¼šé€‰æ‹©æ£€æŸ¥å‘å¸ƒ | `main` | ä¸å‘å¸ƒï¼Œä»…æ£€æŸ¥ | å‘å¸ƒå‰éªŒè¯å’Œé¢„æ£€æŸ¥ |
| **production-publish-pkg** | ä»…æ‰‹åŠ¨è§¦å‘ | `main` | NPM (æ­£å¼ç‰ˆæœ¬) | ç”Ÿäº§ç¯å¢ƒæ­£å¼å‘å¸ƒ |

### ğŸ”’ å®‰å…¨ç­‰çº§

- ğŸŸ¢ **å¿«ç…§å‘å¸ƒ**ï¼šè‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ï¼Œé€‚åˆé¢‘ç¹å‘å¸ƒ
- ğŸŸ¡ **å‘å¸ƒæ£€æŸ¥**ï¼šå®‰å…¨éªŒè¯ï¼Œé˜²æ­¢é”™è¯¯å‘å¸ƒ
- ğŸ”´ **ç”Ÿäº§å‘å¸ƒ**ï¼šæœ€é«˜å®‰å…¨çº§åˆ«ï¼Œä»…æ‰‹åŠ¨è§¦å‘

## å·¥ä½œæµåŸºæœ¬é…ç½®

### åç§°å’Œè§¦å‘æ¡ä»¶

```yaml
name: å¤šåŒ…å‘å¸ƒæµç¨‹

on:
  push:
    branches: ['test', 'feat/**', 'main']
  pull_request:
    branches: ['test', 'feat/**', 'main']
  workflow_dispatch:
    inputs:
      job_type:
        description: 'é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡'
        required: true
        default: 'snapshot-publish'
        type: choice
        options:
          - 'check-releases-packages'
          - 'production-publish-pkg'
```

**è§¦å‘æ–¹å¼ï¼š**

1. **è‡ªåŠ¨è§¦å‘**ï¼šæ¨é€æˆ– PR åˆ° `test`ã€`feat/**`ã€`main` åˆ†æ”¯
2. **æ‰‹åŠ¨è§¦å‘**ï¼šé€šè¿‡ GitHub Actions ç•Œé¢ï¼Œå¯é€‰æ‹©å…·ä½“æ‰§è¡Œçš„ä»»åŠ¡ç±»å‹

### æƒé™è®¾ç½®

```yaml
permissions:
  contents: write # å…è®¸è¯»å†™ä»“åº“å†…å®¹
  packages: write # å…è®¸å‘å¸ƒåŒ…
  pull-requests: write # å…è®¸åˆ›å»º PR
```

è¿™äº›æƒé™ç¡®ä¿å·¥ä½œæµå¯ä»¥ï¼š

- ä¿®æ”¹ä»£ç å’Œåˆ›å»ºæäº¤
- å‘å¸ƒ npm åŒ…
- æ“ä½œ Pull Request

## ä¸‰å¤§æ ¸å¿ƒä»»åŠ¡è¯¦è§£

### 1. å¿«ç…§ç‰ˆæœ¬å‘å¸ƒ (snapshot-publish)

**è§¦å‘æ¡ä»¶ï¼š**

- æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹© `snapshot-publish`ï¼ˆé»˜è®¤é€‰é¡¹ï¼‰
- æ¨é€åˆ° `test` æˆ– `feat/*` åˆ†æ”¯

**ä¸»è¦åŠŸèƒ½ï¼š**

- æ„å»ºå’Œå‘å¸ƒå¸¦æœ‰ `beta` æ ‡ç­¾çš„å¿«ç…§ç‰ˆæœ¬
- ç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒçš„é¢„å‘å¸ƒ

**å…³é”®æ­¥éª¤åˆ†æï¼š**

1. **ç¯å¢ƒå‡†å¤‡**

   ```bash
   # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„å·¥å…·
   pnpm: 9.15.4
   Node.js: 20.17.0
   ```

2. **ä¾èµ–ç®¡ç†**

   ```bash
   pnpm install --frozen-lockfile  # ç¡®ä¿ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§
   ```

3. **æ„å»ºè¿‡ç¨‹**

   ```bash
   pnpm exec zx ./scripts/build.mjs  # ä½¿ç”¨ zx è„šæœ¬æ„å»ºæ‰€æœ‰åŒ…
   ```

4. **NPM è®¤è¯é…ç½®**

   ```bash
   # é…ç½® npm è®¤è¯ä¿¡æ¯
   echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
   echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
   echo "always-auth=true" >> ~/.npmrc
   ```

5. **æ™ºèƒ½å‘å¸ƒé€»è¾‘**

   ```bash
   # åªæœ‰æ£€æµ‹åˆ°å˜æ›´æ—¶æ‰å‘å¸ƒ
   if [[ -n "$(pnpm exec zx ./scripts/check-releases.mjs)" ]]; then
     pnpm exec changeset version --snapshot beta
     pnpm exec changeset publish --tag beta --no-git-tag --snapshot
   fi
   ```

### 2. å‘å¸ƒæ£€æŸ¥ (check-releases-packages)

**è§¦å‘æ¡ä»¶ï¼š**

- æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹© `check-releases-packages`ï¼ˆä»…é™ main åˆ†æ”¯ï¼‰
- æ¨é€åˆ° `main` åˆ†æ”¯

**ä¸»è¦åŠŸèƒ½ï¼š**

- æ£€æŸ¥æ˜¯å¦æœ‰åŒ…éœ€è¦å‘å¸ƒ
- éªŒè¯ changeset é…ç½®çš„æ­£ç¡®æ€§
- ä½œä¸ºç”Ÿäº§å‘å¸ƒå‰çš„é¢„æ£€æŸ¥

**æ£€æŸ¥é€»è¾‘ï¼š**

```bash
OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
if [[ -n "$OUTPUT" ]]; then
  echo "âœ… æ‰¾åˆ°éœ€è¦å‘å¸ƒçš„åŒ…"
else
  echo "âŒ æ²¡æœ‰æ‰¾åˆ°éœ€è¦å‘å¸ƒçš„åŒ…"
  exit 1  # æ£€æŸ¥å¤±è´¥æ—¶é€€å‡º
fi
```

**å¯èƒ½çš„æ£€æŸ¥ç»“æœï¼š**

- âœ… æœ‰åŒ…éœ€è¦å‘å¸ƒï¼šæ˜¾ç¤ºå¾…å‘å¸ƒåŒ…åˆ—è¡¨
- âŒ æ— åŒ…éœ€è¦å‘å¸ƒï¼šå¯èƒ½åŸå› åŒ…æ‹¬æ—  changeset æ–‡ä»¶ã€æ‰€æœ‰å˜æ›´å·²å‘å¸ƒã€é…ç½®é”™è¯¯ç­‰

### 3. ç”Ÿäº§ç¯å¢ƒå‘å¸ƒ (production-publish-pkg)

**è§¦å‘æ¡ä»¶ï¼š**

- **ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘**ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- å¿…é¡»åœ¨ `main` åˆ†æ”¯ä¸Šæ‰§è¡Œ
- å¿…é¡»é€‰æ‹© `production-publish-pkg` ä»»åŠ¡ç±»å‹

**ä¸»è¦åŠŸèƒ½ï¼š**

- æ­£å¼ç‰ˆæœ¬å‘å¸ƒåˆ° npm
- è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·
- æäº¤ç‰ˆæœ¬å˜æ›´åˆ° git

**å®Œæ•´å‘å¸ƒæµç¨‹ï¼š**

1. **å‘å¸ƒå‰æ£€æŸ¥**

   ```bash
   OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
   ```

2. **æ„å»ºåŒ…**

   ```bash
   pnpm exec zx ./scripts/build.mjs
   ```

3. **ç‰ˆæœ¬æ›´æ–°**

   ```bash
   pnpm exec changeset version  # æ ¹æ® changeset æ›´æ–°ç‰ˆæœ¬å·
   ```

4. **å‘å¸ƒåˆ° npm**

   ```bash
   pnpm exec changeset publish  # å‘å¸ƒåˆ° npm registry
   ```

5. **Git æ“ä½œ**
   ```bash
   pnpm exec zx ./scripts/commit-version.mjs  # æäº¤ç‰ˆæœ¬å˜æ›´
   ```

## å®‰å…¨æœºåˆ¶å’Œæœ€ä½³å®è·µ

### 1. åˆ†ç¯å¢ƒå‘å¸ƒç­–ç•¥

- **å¼€å‘/æµ‹è¯•**ï¼šè‡ªåŠ¨å‘å¸ƒå¿«ç…§ç‰ˆæœ¬ï¼ˆbeta æ ‡ç­¾ï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä»…æ”¯æŒæ‰‹åŠ¨å‘å¸ƒï¼Œå¢åŠ å®‰å…¨æ€§

### 2. æƒé™æ§åˆ¶

- ç”Ÿäº§å‘å¸ƒå¿…é¡»åœ¨ `main` åˆ†æ”¯
- ä½¿ç”¨ GitHub Secrets ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆ`NPM_TOKEN`, `ACCESS_TOKEN`ï¼‰

### 3. é”™è¯¯å¤„ç†

- æ£€æŸ¥å‘å¸ƒå‰ç½®æ¡ä»¶
- å‘å¸ƒå¤±è´¥æ—¶æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- ä¿ç•™æ„å»ºäº§ç‰©ä¾¿äºé—®é¢˜æ’æŸ¥

## ä¾èµ–çš„å¤–éƒ¨è„šæœ¬

å·¥ä½œæµä¾èµ–ä»¥ä¸‹è‡ªå®šä¹‰è„šæœ¬ï¼š

1. **`./scripts/build.mjs`** - æ„å»ºæ‰€æœ‰åŒ…
2. **`./scripts/check-releases.mjs`** - æ£€æŸ¥å¾…å‘å¸ƒåŒ…
3. **`./scripts/commit-version.mjs`** - æäº¤ç‰ˆæœ¬å˜æ›´

## ç¯å¢ƒå˜é‡å’Œå¯†é’¥

### å¿…éœ€çš„ GitHub Secretsï¼š

- `NPM_TOKEN` - npm å‘å¸ƒè®¤è¯ä»¤ç‰Œ
- `ACCESS_TOKEN` - GitHub è®¿é—®ä»¤ç‰Œï¼ˆç”¨äº git æ“ä½œï¼‰

## ä½¿ç”¨å»ºè®®

### 1. å¼€å‘é˜¶æ®µ

- åœ¨ `feat/*` åˆ†æ”¯å¼€å‘
- æ¨é€æ—¶è‡ªåŠ¨è§¦å‘å¿«ç…§ç‰ˆæœ¬å‘å¸ƒ
- ä½¿ç”¨ `beta` æ ‡ç­¾çš„åŒ…è¿›è¡Œæµ‹è¯•

### 2. å‘å¸ƒå‰æ£€æŸ¥

- åˆå¹¶åˆ° `main` åˆ†æ”¯å‰ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦æœ‰åŒ…éœ€è¦å‘å¸ƒ
- æ‰‹åŠ¨è¿è¡Œ `check-releases-packages` éªŒè¯å‘å¸ƒå‡†å¤‡æƒ…å†µ

### 3. ç”Ÿäº§å‘å¸ƒ

- ç¡®ä¿åœ¨ `main` åˆ†æ”¯ä¸Šæ“ä½œ
- æ‰‹åŠ¨è§¦å‘ `production-publish-pkg`
- å‘å¸ƒåéªŒè¯ npm ä¸Šçš„åŒ…ç‰ˆæœ¬

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜ï¼š

1. **"æ²¡æœ‰æ‰¾åˆ°éœ€è¦å‘å¸ƒçš„åŒ…"**

   - æ£€æŸ¥æ˜¯å¦æœ‰ `.changeset` æ–‡ä»¶
   - éªŒè¯ changeset é…ç½®
   - ç¡®è®¤å˜æ›´æ˜¯å¦å·²ç»å‘å¸ƒ

2. **npm å‘å¸ƒå¤±è´¥**

   - éªŒè¯ `NPM_TOKEN` æ˜¯å¦æœ‰æ•ˆ
   - æ£€æŸ¥åŒ…åæ˜¯å¦å†²çª
   - ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸

3. **Git æ“ä½œå¤±è´¥**
   - éªŒè¯ `ACCESS_TOKEN` æƒé™
   - æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤è§„åˆ™
   - ç¡®è®¤ Git é…ç½®æ­£ç¡®

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ä¸€ï¼šåŠŸèƒ½å¼€å‘å’Œæµ‹è¯•

```bash
# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feat/add-new-component

# 2. å¼€å‘å¹¶æäº¤ä»£ç 
git add .
git commit -m "feat: add new component"

# 3. æ·»åŠ  changesetï¼ˆå¦‚æœéœ€è¦å‘å¸ƒï¼‰
pnpm changeset
# é€‰æ‹©è¦å‘å¸ƒçš„åŒ…å’Œç‰ˆæœ¬ç±»å‹ï¼ˆpatch/minor/majorï¼‰

# 4. æ¨é€åˆ†æ”¯ - è‡ªåŠ¨è§¦å‘å¿«ç…§å‘å¸ƒ
git push origin feat/add-new-component
```

**CI æ‰§è¡Œæµç¨‹ï¼š**

1. è‡ªåŠ¨è§¦å‘ `snapshot-publish` ä»»åŠ¡
2. æ„å»ºå¹¶å‘å¸ƒå¸¦æœ‰ `beta` æ ‡ç­¾çš„ç‰ˆæœ¬
3. å¯ä»¥é€šè¿‡ `npm install @your-org/package@beta` æµ‹è¯•

### åœºæ™¯äºŒï¼šå‡†å¤‡ç”Ÿäº§å‘å¸ƒ

`feat/add-new-component` åˆ†æ”¯ PR åˆ° `main` åˆ†æ”¯

**CI æ‰§è¡Œæµç¨‹ï¼š**

1. è‡ªåŠ¨è§¦å‘ `check-releases-packages` ä»»åŠ¡
2. æ£€æŸ¥æ˜¯å¦æœ‰åŒ…éœ€è¦å‘å¸ƒ
3. å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œè¯´æ˜å¯ä»¥è¿›è¡Œç”Ÿäº§å‘å¸ƒ

### åœºæ™¯ä¸‰ï¼šç”Ÿäº§ç¯å¢ƒå‘å¸ƒ

1. åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
2. é€‰æ‹© `production-publish-pkg` ä»»åŠ¡
3. ç¡®è®¤åœ¨ `main` åˆ†æ”¯ä¸Šæ‰§è¡Œ

**CI æ‰§è¡Œæµç¨‹ï¼š**

1. æ„å»ºæ‰€æœ‰åŒ…
2. æ ¹æ® changeset è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·
3. å‘å¸ƒåˆ° npm registry
4. æäº¤ç‰ˆæœ¬å˜æ›´åˆ° git
5. åˆ›å»º git tags

### å®é™…è¾“å‡ºç¤ºä¾‹

**å¿«ç…§å‘å¸ƒæˆåŠŸè¾“å‡ºï¼š**

```
ğŸ“¦ Found packages to publish, creating snapshot version...
ğŸš€ Publishing packages with beta tag:
  - @your-org/hooks@1.2.3-beta.1
  - @your-org/utils@2.1.0-beta.1
âœ… Snapshot packages published successfully
```

**ç”Ÿäº§å‘å¸ƒæˆåŠŸè¾“å‡ºï¼š**

```
ğŸ“‹ æ£€æµ‹åˆ°éœ€è¦å‘å¸ƒçš„åŒ…ï¼š
  - @your-org/hooks (1.2.2 â†’ 1.2.3)
  - @your-org/utils (2.0.1 â†’ 2.1.0)

ğŸ“¦ æ„å»ºåŒ…...
ğŸ”– æ›´æ–°ç‰ˆæœ¬...
ğŸš€ å‘å¸ƒåŒ…...
ğŸ’¾ æäº¤ç‰ˆæœ¬å˜æ›´...
âœ… ç”Ÿäº§ç¯å¢ƒåŒ…å‘å¸ƒå®Œæˆ
```

## ä¸ changeset å·¥ä½œæµé›†æˆ

è¿™ä¸ª CI å·¥ä½œæµä¸ [changeset](https://github.com/changesets/changesets) æ·±åº¦é›†æˆï¼š

### 1. å¼€å‘é˜¶æ®µ

```bash
# æ·»åŠ å˜æ›´è¯´æ˜
pnpm changeset
```

### 2. changeset æ–‡ä»¶ç¤ºä¾‹

```markdown
---
'@your-org/hooks': minor
'@your-org/utils': patch
---

Add new useDebounce hook and fix utility function bug
```

### 3. ç‰ˆæœ¬æ›´æ–°å’Œå‘å¸ƒ

- **å¿«ç…§ç‰ˆæœ¬**ï¼š`changeset version --snapshot beta`
- **æ­£å¼ç‰ˆæœ¬**ï¼š`changeset version`
- **å‘å¸ƒ**ï¼š`changeset publish`

## æ€»ç»“

è¿™ä¸ª GitHub Actions å·¥ä½œæµæä¾›äº†ï¼š

âœ¨ **å®Œæ•´çš„å‘å¸ƒæµæ°´çº¿**

- å¼€å‘ç¯å¢ƒå¿«ç…§å‘å¸ƒ
- ç”Ÿäº§å‰æ£€æŸ¥éªŒè¯
- å®‰å…¨çš„ç”Ÿäº§å‘å¸ƒ

ğŸ›¡ï¸ **å¤šå±‚å®‰å…¨ä¿éšœ**

- åˆ†æ”¯æƒé™æ§åˆ¶
- æ‰‹åŠ¨å®¡æ‰¹ç”Ÿäº§å‘å¸ƒ
- å®Œæ•´çš„é”™è¯¯å¤„ç†

ğŸ”„ **è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜**

- è‡ªåŠ¨æ„å»ºå’Œç‰ˆæœ¬ç®¡ç†
- æ™ºèƒ½æ£€æµ‹å‘å¸ƒéœ€æ±‚
- è‡ªåŠ¨æäº¤ç‰ˆæœ¬å˜æ›´

è¿™å¥—å·¥ä½œæµç‰¹åˆ«é€‚åˆå¤šåŒ… monorepo é¡¹ç›®ï¼Œèƒ½å¤Ÿæœ‰æ•ˆç®¡ç†åŒ…çš„ç‰ˆæœ¬å‘å¸ƒï¼Œç¡®ä¿å‘å¸ƒæµç¨‹çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚
